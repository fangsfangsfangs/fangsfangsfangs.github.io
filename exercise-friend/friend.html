<!doctype html>
<html lang="en">
    <head>
        <title>Exercise Friend</title>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <style>
            @import url("https://fonts.googleapis.com/css2?family=Noto+Sans:ital,wght@0,100..900;1,100..900&family=Noto+Serif:ital,wght@0,100..900;1,100..900&display=swap");

            body {
                font-family: "Noto Serif", serif;
                color: #303028;
                background-color: #dcddd3;
                font-size: 14px;
                margin: 0;
                padding: 0;
                display: flex;
                justify-content: center;
                align-items: center;
            }
            .container {
                width: 50%;
                margin-top: 40px;
            }

            .accordion {
                border-bottom: 0px solid #ccc;
            }

            .accordion-header {
                padding: 8px;
                cursor: pointer;
                display: flex;
                align-items: center;
            }

            .accordion-content {
                display: none;
                padding: 10px;
            }

            .stretch-row {
                display: flex;
                justify-content: space-between;
                align-items: center;
                padding: 6px 0;
            }

            .stretch-left {
                display: flex;
                align-items: center;
            }

            .stretch-right {
                display: flex;
                align-items: center;
                gap: 8px;
            }

            audio {
                width: 100%;
            }

            audio::-webkit-media-controls-panel {
                background-color: #ffffff;
            }

            audio::-webkit-media-controls-enclosure {
                border-radius: 0;
            }

            input[type="checkbox"] {
                width: 20px;
                height: 20px;
                margin: 0 6px;
                vertical-align: middle;
            }

            label {
                margin-left: 12px;
            }

            button {
                font-family: "Noto Serif", serif;
                font-size: 16px;
                padding: 10px 30px;
                background-color: #ff7333;
                color: #404030;
                border: none;
                text-align: center;
                cursor: pointer;
                white-space: nowrap;
            }

            #themeToggleBtn {
                position: fixed;
                bottom: 16px;
                right: 16px;
                font-size: 18px;
                padding: 10px 16px;
                background-color: #ff7333;
                border: none;
                border-radius: 4px;
                color: #fff;
                cursor: pointer;
                z-index: 1000;
            }

            .triangle {
                margin: 0 10px;
                display: inline-block;
            }

            .infotag {
                margin-left: 8px;
            }

            .time {
                color: #9ea0bf;
            }

            .reps {
                color: #9ea0bf;
            }

            .sides {
                color: #dcb38b;
            }

            .grouptime {
                color: #ffffff;
                margin-left: auto;
                font-weight: bold;
            }

            #speakButton span {
                display: inline-block;
                animation: wave 0.75s infinite steps(1);
            }

            @keyframes wave {
                50% {
                    transform: translateY(-4px);
                }
            }

            @media only screen and (max-width: 800px) {
                .container {
                    width: 90%;
                }
            }
        </style>
    </head>
    <body>
        <div class="container">
            <div style="display: flex; margin-bottom: 20px">
                <button id="speakButton" onclick="speak()">start! âŸ¶</button>
                <audio id="audio" controls>your browser doesn't support the audio element.</audio>
                <audio id="holdMusicAudio" preload="auto"></audio>
            </div>

            <div id="stretchList"></div>
        </div>

        <!-- ðŸŽ¨ Theme Toggle Button -->
        <button id="themeToggleBtn" title="Toggle Color Theme">ðŸŽ¨</button>

        <script>
            const colorThemes = [
                {
                    name: "sfd original",
                    backgroundColor: "#e3e3e3",
                    textColor: "#303028",
                    buttonColor: "#dcb38b",
                    headerColors: ["#d3c8c3", "#d3b690", "#b9af2a", "#b0b4b4", "#d4be96", "#dcb38b"]
                },
                {
                    name: "summer's ending ",
                    backgroundColor: "#dbd4b8",
                    textColor: "#1B5E20",
                    buttonColor: "#66BB6A",
                    headerColors: ["#FFF1CA", "#fab627", "#a1b16d", "#8a7f58", "#708A58"]
                },
                {
                    name: "blue",
                    backgroundColor: "#E3F2FD",
                    textColor: "#191a1e",
                    buttonColor: "#66BB6A",
                    headerColors: ["#edf7ff","#90CAF9", "#54acf2", "#2e7ad0"]
                },
                {
                    name: "Dirt sunset",
                    backgroundColor: "#b7b8be",
                    textColor: "#463411",
                    buttonColor: "#f5c53e",
                    headerColors: ['#67533e', '#ead0af', '#c6b594', '#77613d']
                },
                 {
                    name: "dark mode",
                    backgroundColor: "#393939",
                    textColor: "#000000",
                    buttonColor: "#e3a6af",
                    headerColors: ["#b4b4b4", "#ade0e7", "#7b7b7b", "#5c5c5c","#e7adad"]
                }
            ];

            let currentThemeIndex = 0;
            let currentColorIndex = 0;
            var ssml = "";

            const holdAudioClips = [
                "https://fangsfangsfangs.github.io/exercise-friend/30-1.mp3",
                "https://fangsfangsfangs.github.io/exercise-friend/30-2.mp3",
                "https://fangsfangsfangs.github.io/exercise-friend/30-3.mp3",
                "https://fangsfangsfangs.github.io/exercise-friend/30-4.mp3",
                "https://fangsfangsfangs.github.io/exercise-friend/30-5.mp3"
            ];

            function getRandomHoldAudioUrl() {
                const index = Math.floor(Math.random() * holdAudioClips.length);
                return holdAudioClips[index];
            }

            function playRandomHoldAudio() {
                const holdAudio = document.getElementById("holdMusicAudio");
                holdAudio.src = getRandomHoldAudioUrl();
                holdAudio.play().catch((e) => console.log("Hold music playback failed:", e));
            }

            fetch("https://opensheet.elk.sh/1rLG4dApWPjAiGRwVKSGjoHqnBFvVyRrR34sYN82hycQ/exercises")
                .then((response) => {
                    if (!response.ok) throw new Error("network response error");
                    return response.json();
                })
                .then((data) => createElements(data))
                .catch((error) => console.error("data fetching error", error));

            function createElements(data) {
                const stretchList = document.getElementById("stretchList");
                const groupCheckboxes = {};

                data.forEach((item) => {
                    const groupName = item.group;

                    if (!groupCheckboxes[groupName]) {
                        const accordion = document.createElement("div");
                        accordion.className = "accordion";

                        const header = document.createElement("div");
                        header.className = "accordion-header";

                        const triangle = document.createElement("div");
                        triangle.className = "triangle";
                        triangle.textContent = "â–¶";
                        triangle.onclick = function () {
                            toggleAccordion(header);
                        };

                        const groupCheckboxInput = document.createElement("input");
                        groupCheckboxInput.type = "checkbox";
                        groupCheckboxInput.checked = false;

                        const groupLabel = document.createElement("label");
                        groupLabel.textContent = groupName.replace(/_/g, " ");

                        groupCheckboxInput.addEventListener("change", function () {
                            const nestedCheckboxes = stretchList.querySelectorAll(
                                `input[type='checkbox'][data-group='${CSS.escape(groupName)}']`
                            );
                            nestedCheckboxes.forEach((checkbox) => {
                                checkbox.checked = this.checked;
                            });
                        });

                        const content = document.createElement("div");
                        content.className = "accordion-content";

                        header.appendChild(triangle);
                        header.appendChild(groupCheckboxInput);
                        header.appendChild(groupLabel);
                        accordion.appendChild(header);
                        accordion.appendChild(content);

                        groupCheckboxes[groupName] = {
                            accordion: accordion,
                            content: content
                        };

                        stretchList.appendChild(accordion);

                        const theme = colorThemes[currentThemeIndex];
                        const color = theme.headerColors[currentColorIndex % theme.headerColors.length];
                        header.style.backgroundColor = color;
                        currentColorIndex++;
                    }

                    const stretchRow = document.createElement("div");
                    stretchRow.classList.add("stretch-row");

                    const leftSide = document.createElement("div");
                    leftSide.classList.add("stretch-left");

                    const stretchCheckbox = document.createElement("input");
                    stretchCheckbox.type = "checkbox";
                    stretchCheckbox.checked = false;
                    stretchCheckbox.dataset.group = groupName;
                    stretchCheckbox.dataset.time = item.time;
                    stretchCheckbox.dataset.bothsides = item.bothsides;
                    stretchCheckbox.dataset.recover = item.recover;
                    stretchCheckbox.dataset.reps = item.reps;

                    const stretchLabel = document.createElement("label");
                    stretchLabel.textContent = item.stretch;

                    leftSide.appendChild(stretchCheckbox);
                    leftSide.appendChild(stretchLabel);

                    const rightSide = document.createElement("div");
                    rightSide.classList.add("stretch-right");

                    const timeVal = parseInt(item.time);
                    const repCount = parseInt(item.reps);
                    const isHold = timeVal > 5;
                    const isReps = repCount > 1;

                    if (isReps) {
                        const repspan = document.createElement("span");
                        repspan.classList.add("reps", "infotag");
                        repspan.textContent = repCount + " reps";
                        rightSide.appendChild(repspan);
                    }

                    const timeLabel = document.createElement("span");
                    timeLabel.classList.add("time", "infotag");
                    timeLabel.textContent = isHold ? `${timeVal} sec` : `${timeVal} seconds`;
                    rightSide.appendChild(timeLabel);

                    if (item.bothsides === "y") {
                        const sidesspan = document.createElement("span");
                        sidesspan.classList.add("sides", "infotag");
                        sidesspan.textContent = "per side";
                        rightSide.appendChild(sidesspan);
                    }

                    stretchRow.appendChild(leftSide);
                    stretchRow.appendChild(rightSide);
                    groupCheckboxes[groupName].content.appendChild(stretchRow);
                });

                for (let groupName in groupCheckboxes) {
                    const checkboxes = groupCheckboxes[groupName].content.querySelectorAll("input[type='checkbox']");
                    const filteredTextList = Array.from(checkboxes);
                    generatessml(filteredTextList);
                    let totalSeconds = estimateReadingTime(ssml);
                    let minutes = Math.round(totalSeconds / 60);
                    let seconds = Math.round(totalSeconds % 60);
                    if (seconds < 10) seconds = "0" + seconds;

                    const headerDiv = groupCheckboxes[groupName].accordion.querySelector(".accordion-header");
                    const spanElement = document.createElement("span");
                    spanElement.textContent = `${minutes}:${seconds}`;
                    spanElement.classList.add("grouptime", "infotag");
                    headerDiv.appendChild(spanElement);
                }
            }
            //open and close the exercise group accordions
            function toggleAccordion(header) {
                const content = header.nextElementSibling;
                if (content.style.display === "block") {
                    content.style.display = "none";
                    header.querySelector(".triangle").textContent = "â–¶";
                } else {
                    content.style.display = "block";
                    header.querySelector(".triangle").textContent = "â–¼";
                }
            }

            console.log(ssml);

            // Theme toggle logic
            document.getElementById("themeToggleBtn").addEventListener("click", () => {
                currentThemeIndex = (currentThemeIndex + 1) % colorThemes.length;
                currentColorIndex = 0;

                const theme = colorThemes[currentThemeIndex];

                // Set background color of body
                document.body.style.backgroundColor = theme.backgroundColor;

                // Set accordion header colors
                const headers = document.querySelectorAll(".accordion-header");
                headers.forEach((header, i) => {
                    const newColor = theme.headerColors[i % theme.headerColors.length];
                    header.style.backgroundColor = newColor;
                });
            });

            function speak() {
                //do the loading animation
                const speakBtn = document.getElementById("speakButton");
                const audioElem = document.getElementById("audio");

                // Animated button text
                const loadingText = "get ready";
                speakBtn.innerHTML = loadingText
                    .split("")
                    .map((letter) => `<span>${letter}</span>`)
                    .join("");
                document.querySelectorAll("#speakButton span").forEach((el, i) => {
                    el.style.animationDelay = `${i * 0.1}s`;
                });

                // Get checked exercises
                const checkboxes = Array.from(document.querySelectorAll("#stretchList input[type='checkbox']")).filter(
                    (cb) => cb.checked && cb.dataset.group !== undefined
                );

                generatessml(checkboxes);
                const duration = estimateReadingTime(ssml);
                const minutes = Math.floor(duration / 60);
                const seconds = Math.floor(duration % 60);
                ssml = ssml.replace(
                    "hope you enjoy it.",
                    `hope you enjoy it. It should take about ${minutes} minutes and ${seconds} seconds.`
                );

                console.log("SSML:", ssml);

                // TTS request
                const xhr = new XMLHttpRequest();
                xhr.open(
                    "POST",
                    "https://texttospeech.googleapis.com/v1/text:synthesize?key=AIzaSyDpqDvoizSQhcpwDpO604yvLIvbMpo-bMU",
                    true
                );
                xhr.onreadystatechange = function () {
                    if (xhr.readyState === 4 && xhr.status === 200) {
                        const response = JSON.parse(xhr.responseText);
                        const audioUrl = "data:audio/mp3;base64," + response.audioContent;
                        audioElem.src = audioUrl;

                        // Only play hold music AFTER TTS finishes
                        audioElem.onended = () => {
                            const holdAudio = document.getElementById("holdMusicAudio");
                            holdAudio.src = getRandomHoldAudioUrl();
                            holdAudio.play().catch((e) => console.log("Hold music error:", e));
                        };

                        audioElem.play();
                        speakBtn.innerHTML = "start! âŸ¶";
                    }
                };
                const data = JSON.stringify({
                    input: { ssml: ssml },
                    voice: { languageCode: "en-IN", name: "en-IN-Standard-E", ssmlGender: "FEMALE" },
                    audioConfig: { audioEncoding: "MP3" }
                });
                xhr.send(data);
            }

            //make ssml for the robot to speak
            function generatessml(filteredTextList) {
                ssml = "<speak>";
                ssml += 'hello elliott, itâ€™s time to exercise! I hope you enjoy it. <break time="1s"/>';

                filteredTextList.forEach((checkbox, index) => {
                    const text = checkbox.nextSibling.textContent.trim();
                    const exercisetime = parseInt(checkbox.dataset.time, 10) || 0;
                    const bothsides = checkbox.dataset.bothsides === "y";
                    const reps = parseInt(checkbox.dataset.reps, 10) || 1;
                    const recover = parseInt(checkbox.dataset.recover, 10) || 0;

                    const nextItem = filteredTextList[index + 1];
                    const nextexercise = nextItem ? nextItem.nextSibling.textContent.trim() : null;

                    const isHold = exercisetime > 5;

                    function addBreakOrAudio(time) {
                        if (time === 30) {
                            const audioUrl = getRandomHoldAudioUrl();
                            ssml += `<audio src="${audioUrl}"/>`;
                        } else {
                            ssml += ` <break time="${time}s"/> `;
                        }
                    }

                    function addRepsBlock(label) {
                        ssml += `${label} <break time="1s"/> `;
                        for (let i = 0; i < reps; i++) {
                            ssml += `${i + 1}`;
                            if (isHold) {
                                ssml += `, hold for ${exercisetime} seconds.`;
                                addBreakOrAudio(exercisetime);
                            } else {
                                ssml += ` <break time="${exercisetime}s"/> `;
                            }
                        }
                    }

                    function addSingleHold(label) {
                        ssml += `${label}, hold for ${exercisetime} seconds.`;
                        addBreakOrAudio(exercisetime);
                    }

                    // Determine how to render this exercise
                    if (reps > 1) {
                        if (bothsides) {
                            addRepsBlock(`${text}, right side`);
                            addRepsBlock(`${text}, left side`);
                        } else {
                            addRepsBlock(text);
                        }
                    } else {
                        if (bothsides) {
                            addSingleHold(`${text}, right side`);
                            addSingleHold(`${text}, left side`);
                        } else {
                            addSingleHold(text);
                        }
                    }

                    // Add recovery and "get ready" prompt if applicable
                    if (recover > 0) {
                        ssml += `rest for ${recover} seconds. <break time="${recover}s"/> `;
                        if (nextexercise) {
                            ssml += `get ready for ${nextexercise}. <break time="3s"/> `;
                        }
                    }
                });

                ssml += "you did it. go and live your life and have fun. see you next time.";
                ssml += "</speak>";
            }

            //estimate time it takes to read any given ssml
            function estimateReadingTime(ssml) {
                const wordsPerSecond = 1.5;
                const textContent = ssml.replace(/<[^>]*>/g, "");
                const wordCount = textContent.split(/\s+/).filter((w) => w.length > 0).length;
                let estimatedTime = wordCount / wordsPerSecond;
                const breakTags = ssml.match(/<break[^>]*time=\"([\d.]+)s\"[^>]*>/g) || [];
                breakTags.forEach((tag) => {
                    const match = tag.match(/time=\"([\d.]+)s\"/);
                    if (match) estimatedTime += parseFloat(match[1]);
                });
                return estimatedTime;
            }
        </script>
    </body>
</html>
